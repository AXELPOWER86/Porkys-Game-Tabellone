<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width,
               initial-scale=1.0,
               minimum-scale=0.5,
               maximum-scale=3.0,
               user-scalable=yes">

<div id="exit-zone">✕</div>
<title>Porky's Game - Carte</title>

<!-- LIBRERIE ORIGINALI -->
<script src="js/jszip.min.js"></script>
<script src="js/localforage.min.js"></script>

<style>
  /* EXIT ZONE */
  #exit-zone {
    position: fixed;
    top: 0;
    right: 0;
    width: 80px;
    height: 80px;
    background: rgba(0,0,0,0.7);
    color: white;
    font-size: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    opacity: 0;
    pointer-events: none;
    transition: opacity .3s;
    z-index: 9999;
  }
  #exit-zone.active {
    opacity: 1;
    pointer-events: auto;
  }

  /* GRAFICA TABELLONE */
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    min-height: 100vh;
    background:
      linear-gradient(rgba(215,175,90,.85), rgba(215,175,90,.85)),
      url("images/logo_splash.png") center/cover no-repeat;
  }

  h1 { color:#502369; margin-top:18px; }

  button {
    padding:10px;
    margin:5px;
    font-size:16px;
    border:none;
    border-radius:6px;
    cursor:pointer;
    font-weight:bold;
  }

  .btn { background:linear-gradient(145deg,#dfad24,#9b710e); color:#3b2500; }
  .reset,.cancellaMazzo { background:linear-gradient(145deg,#b00b0b,#910101); color:#fff; }

  .info { font-size:18px; color:#502369; font-weight:bold; }

  input[type=file] { display:none; }

  .carta {
    width: 180px;
    height: 300px;
    margin: 20px auto;
    border-radius: 10px;
    background:
      radial-gradient(circle at top, rgba(255,215,120,.35), rgba(80,0,40,.9));
    background-image: url('images/Grafica_carte.png');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow:
      0 0 15px rgba(245,197,66,.4),
      inset 0 0 10px rgba(0,0,0,.5);
  }

  .carta img {
    width:100%; height:100%;
    object-fit:cover;
    border-radius:10px;
  }

  .shuffle {
    animation: shake .5s infinite;
  }

  @keyframes shake {
    0%{transform:rotateZ(0)}
    25%{transform:rotateY(180deg)}
    50%{transform:rotateX(-180deg)}
    75%{transform:rotateY(180deg)}
    100%{transform:rotateZ(0)}
  }

  /* POPUP MODALE (CONFIRM + ALERT) */
  #modalOverlay {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.6);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:10000;
  }

  #modalBox {
    background:#f9e0a7;
    border:4px solid #502369;
    border-radius:14px;
    padding:25px;
    min-width:280px;
    color:#502369;
    text-align:center;
    font-size:18px;
  }

  /* POPUP SCELTA AGGIUNTA CARTE */
  #popupAddOverlay {
    position:fixed;
    inset:0;
    display:none;
    background:rgba(0,0,0,.6);
    align-items:center;
    justify-content:center;
    z-index:10000;
  }
  #popupAddBox {
    background:#f9e0a7;
    border:4px solid #502369;
    border-radius:14px;
    padding:25px;
    min-width:260px;
    color:#502369;
    text-align:center;
    font-size:18px;
  }
</style>
</head>

<body>

<h1>Porky's Game – Carte</h1>

<div>
  <button class="btn" onclick="apriZip()">Carica mazzo</button>
  <button class="btn" id="btnImg">Aggiungi carte</button>

  <!-- INPUT ZIP ORIGINALE -->
  <input type="file" id="zipInput" accept=".zip" multiple>

  <!-- INPUT FILE IMMAGINI -->
  <input type="file" id="fileInput" accept="image/*" multiple hidden>

  <!-- INPUT CARTELLE + SOTTOCARTELLE -->
  <input type="file" id="folderInput" webkitdirectory directory multiple hidden>
</div>

<div class="info">
  Carte nel mazzo: <span id="contatore">0</span>
</div>

<div id="cartaEstratta" class="carta"></div>

<button class="btn" onclick="estraiCarta()">ESTRAI</button>
<button class="reset" onclick="resetPartita()">RESET</button>

<div>
  <button class="cancellaMazzo" id="cancellaMazzoBtn">CANCELLA MAZZO</button>
  <button id="backBtn"
    style="padding:10px 15px;margin-left:5px;background:#01893a;color:white;border:none;border-radius:6px;cursor:pointer;">
    ⬅ Home Page
  </button>
</div>

<!-- POPUP SCELTA -->
<div id="popupAddOverlay">
  <div id="popupAddBox">
    <div style="margin-bottom:20px;font-weight:bold;">
      Aggiungi carte
    </div>

    <button class="btn" id="btnChooseFiles" style="margin-bottom:10px;">
      Seleziona immagini
    </button><br>

    <button class="btn" id="btnChooseFolder" style="margin-bottom:10px;">
      Seleziona cartella
    </button><br>

    <button class="reset" id="btnClosePopup">
      Annulla
    </button>
  </div>
</div>

<!-- POPUP MODALE ORIGINALE -->
<div id="modalOverlay">
  <div id="modalBox">
    <div id="modalText" style="margin-bottom:20px;"></div>
    <button id="modalOk" class="reset">SI</button>
    <button id="modalCancel" class="btn">NO</button>
    <button id="notifica" class="btn">OK</button>
  </div>
</div>
<script>
/* =================== VARIABILI =================== */
let mazzo = [];
let carteEstratte = [];

localforage.config({
  name: 'PorkysGame',
  storeName: 'mazzo_carte'
});

/* =================== AVVIO =================== */
document.addEventListener("DOMContentLoaded", () => {
  caricaMazzoAllAvvio();
});

/* =================== ZIP =================== */
function apriZip() {
  zipInput.value = "";
  zipInput.click();
}

zipInput.addEventListener("change", async () => {
  const files = [...zipInput.files];
  if (!files.length) return;

  const btn = document.querySelector(".btn[onclick='apriZip()']");
  const originalTxt = btn.textContent;
  btn.disabled = true;
  btn.textContent = "Caricamento...";

  for (const file of files) {
    if (!file.name.toLowerCase().endsWith(".zip")) continue;

    const zip = await JSZip.loadAsync(file);
    const entries = Object.values(zip.files)
      .filter(f => !f.dir && /\.(png|jpe?g|webp)$/i.test(f.name));

    for (const img of entries) {
      const base64 = await img.async("base64");
      const data = `data:image/png;base64,${base64}`;
      const hash = await generaHash(data);
      pushCarta(hash, data, img.name);
    }
  }

  await salvaCarte();
  aggiornaContatore();
  btn.disabled = false;
  btn.textContent = originalTxt;
  customAlert("Mazzo caricato!");
});

/* =================== POPUP Aggiungi =================== */
btnImg.addEventListener("click", () => {
  popupAddOverlay.style.display = "flex";
});

btnClosePopup.addEventListener("click", () => {
  popupAddOverlay.style.display = "none";
});

btnChooseFiles.addEventListener("click", () => {
  popupAddOverlay.style.display = "none";
  fileInput.value = "";
  fileInput.click();
});

btnChooseFolder.addEventListener("click", () => {
  popupAddOverlay.style.display = "none";
  folderInput.value = "";
  folderInput.click();
});

/* =================== FILE SINGOLI =================== */
fileInput.addEventListener("change", async () => {
  const files = [...fileInput.files];
  if (!files.length) return;

  let pending = files.length;
  for (const f of files) {
    if (!f.type.startsWith("image/")) {
      pending--;
      continue;
    }

    const reader = new FileReader();
    reader.onload = async e => {
      const data = e.target.result;
      const hash = await generaHash(data);
      pushCarta(hash, data, f.name);
      pending--;
      if (pending === 0) {
        await salvaCarte();
        aggiornaContatore();
        customAlert("Carte caricate!");
      }
    };
    reader.readAsDataURL(f);
  }
});

/* =================== CARTELLE =================== */
folderInput.addEventListener("change", async () => {
  const files = [...folderInput.files];
  if (!files.length) return;

  let pending = files.length;
  for (const f of files) {
    if (!f.type.startsWith("image/")) {
      pending--;
      continue;
    }
    const reader = new FileReader();
    reader.onload = async e => {
      const data = e.target.result;
      const hash = await generaHash(data);
      pushCarta(hash, data, f.name);
      pending--;
      if (pending === 0) {
        await salvaCarte();
        aggiornaContatore();
        customAlert("Carte caricate!");
      }
    };
    reader.readAsDataURL(f);
  }
});

/* =================== HASH =================== */
function generaHash(dataURL) {
  return crypto.subtle.digest("SHA-256", new TextEncoder().encode(dataURL))
    .then(buf =>
      Array.from(new Uint8Array(buf))
        .map(b => b.toString(16).padStart(2, "0"))
        .join("")
    );
}

/* =================== PUSH CON DEDUP + RINOMINA =================== */
function pushCarta(hash, img, nomeOriginale = null) {
  // dedup sul contenuto
  if (mazzo.some(c => c.hash === hash)) {
    return;
  }

  let nome = nomeOriginale || "carta";

  // rinomina se esiste
  if (mazzo.some(c => c.nome === nome)) {
    nome = resolveNome(nome);
  }

  mazzo.push({
    hash,
    img,
    nome,
    originale: nomeOriginale,
    estratta: false
  });
}

function resolveNome(base) {
  const extMatch = base.match(/\.[a-z0-9]+$/i);
  const ext = extMatch ? extMatch[0] : "";
  const root = ext ? base.replace(ext, "") : base;

  let i = 2;
  let nuovo;

  do {
    nuovo = `${root} (${i})${ext}`;
    i++;
  } while (mazzo.some(c => c.nome === nuovo));

  return nuovo;
}

/* =================== SALVATAGGIO =================== */
async function salvaCarte() {
  try {
    await localforage.setItem("mazzo", mazzo);
  } catch (e) {
    customAlert("Errore nel salvataggio!");
  }
}

async function caricaMazzoAllAvvio() {
  try {
    const salvato = await localforage.getItem("mazzo");
    if (salvato && Array.isArray(salvato)) {
      mazzo = salvato;
      aggiornaContatore();
      resetCartaVisuale();
    }
  } catch(e){}
}

/* =================== GIOCO =================== */
function aggiornaContatore() {
  contatore.innerText = mazzo.filter(c => !c.estratta).length;
}

function resetCartaVisuale() {
  cartaEstratta.innerHTML = "";
}

function estraiCarta() {
  const disp = mazzo.filter(c => !c.estratta);
  if (!disp.length) {
    customAlert("Non esistono carte da estrarre!");
    return;
  }

  cartaEstratta.classList.add("shuffle");
  setTimeout(() => {
    cartaEstratta.classList.remove("shuffle");
    const carta = disp[Math.floor(Math.random() * disp.length)];
    carta.estratta = true;
    cartaEstratta.innerHTML = `<img src="${carta.img}">`;
    aggiornaContatore();
    salvaCarte();
  }, 800);
}

function resetPartita() {
  mazzo.forEach(c => c.estratta = false);
  resetCartaVisuale();
  aggiornaContatore();
  salvaCarte();
}

/* =================== CANCELLA MAZZO =================== */
cancellaMazzoBtn.addEventListener("click", () => {
  customConfirm("Vuoi cancellare TUTTO il mazzo?").then(async ok => {
    if (!ok) return;
    mazzo = [];
    carteEstratte = [];
    await localforage.removeItem("mazzo");
    resetCartaVisuale();
    aggiornaContatore();
    customAlert("Mazzo cancellato!");
  });
});

/* =================== BACK HOME =================== */
backBtn.addEventListener("click", () => {
  window.location.href = "./index.html";
});

/* =================== CUSTOM CONFIRM =================== */
function customConfirm(msg) {
  return new Promise(resolve=>{
    modalText.textContent = msg;
    modalOk.style.display="inline-block";
    modalCancel.style.display="inline-block";
    notifica.style.display="none";
    modalOverlay.style.display="flex";
    modalOk.onclick=()=>{modalOverlay.style.display="none";resolve(true);}
    modalCancel.onclick=()=>{modalOverlay.style.display="none";resolve(false);}
  });
}

/* =================== CUSTOM ALERT =================== */
function customAlert(msg) {
  return new Promise(resolve=>{
    modalText.textContent = msg;
    modalOk.style.display="none";
    modalCancel.style.display="none";
    notifica.style.display="inline-block";
    modalOverlay.style.display="flex";
    notifica.onclick=()=>{modalOverlay.style.display="none";resolve();}
  });
}
</script>

</body>
</html>
